language: cpp

os: linux
dist: bionic

before_install:
  - wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
  - sudo add-apt-repository -y 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-9 main'
  - sudo add-apt-repository -y 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-10 main'
  - sudo add-apt-repository -y 'ppa:ubuntu-toolchain-r/test'
  - sudo apt-get -y install ninja-build libstdc++6 libxml2-dev clang-tidy-10

jobs:
  include:

    ################
    # Clang on linux

    # Clang legacy
    - name: Clang-9 Debug
      stage: Legacy
      env: CXX=clang++-9 BUILD_TYPE=Debug LLVM_VERSION=9
      addons: &clang9
        apt:
          packages:
            - llvm-9-dev
            - clang-9
    - name: Clang-9 Release
      stage: Legacy
      env: CXX=clang++-9 BUILD_TYPE=Release LLVM_VERSION=9
      addons: *clang9

    # Clang latest
    - name: Clang-10 Debug
      stage: Latest
      env: CXX=clang++-10 BUILD_TYPE=Debug
      addons: &clang10
        apt:
          packages:
            - llvm-10-dev
            - clang-10
    - name: Clang-10 Release
      stage: Latest
      env: CXX=clang++-10 BUILD_TYPE=Release
      addons: *clang10

    ##############
    # GCC on linux

    # GCC latest
    - name: GCC-9 Debug
      stage: Latest
      env: CXX=g++-9 BUILD_TYPE=Debug
      addons: &gcc9
        apt:
          packages:
            - llvm-10-dev
            - g++-9
    - name: GCC-9 Release
      env: CXX=g++-9 BUILD_TYPE=Release
      addons: *gcc9

script:
  - mkdir build
  - cd build
  - cmake .. -GNinja -DCMAKE_BUILD_TYPE=${BUILD_TYPE:?} -DLLVM_REQUESTED_VERSION=${LLVM_VERSION} -DPYTHON_EXECUTABLE=$(which python3)
  - cmake --build .
  - cmake --build . --target check-vara-feature-unittests
  - cmake --build . --target tidy-vara-feature
  - cmake --build . --target check-vara-feature-python

#branches:
#  only:
#    - vara
#    - vara-dev
