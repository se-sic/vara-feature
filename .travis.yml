language: cpp

os: linux
dist: bionic

before_install:
  - sudo apt-get -y install libstdc++6 libxml2-dev graphviz

jobs:
  include:

    ################
    # Clang on linux

    # Clang legacy
    - name: Clang-10 Debug
      stage: Legacy
      addons: &clang10
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-10 main'
              key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
            - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-11 main'
              key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
          packages:
            - llvm-10-dev
            - clang++-10
            - clang-tidy-11
      env: CXX=clang++-10 BUILD_TYPE=Debug LLVM_VERSION=10
    - name: Clang-10 Release
      stage: Legacy
      addons: *clang10
      env: CXX=clang++-10 BUILD_TYPE=Release LLVM_VERSION=10

    # Clang latest
    - name: Clang-11 Debug
      stage: Latest
      addons: &clang11
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-11 main'
              key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
          packages:
            - llvm-11-dev
            - clang++-11
            - clang-tidy-11
      env: CXX=clang++-11 BUILD_TYPE=Debug LLVM_VERSION=11
    - name: Clang-11 Release
      stage: Latest
      addons: *clang11
      env: CXX=clang++-11 BUILD_TYPE=Release LLVM_VERSION=11

    ##############
    # GCC on linux

    # GCC latest
    - name: GCC-9 Debug
      stage: Latest
      addons: &gcc9
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-11 main'
              key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
            - sourceline: ppa:ubuntu-toolchain-r/test
          packages:
            - llvm-11-dev
            - g++-9
            - clang-tidy-11
      env: CXX=g++-9 BUILD_TYPE=Debug LLVM_VERSION=11
    - name: GCC-9 Release
      stage: Latest
      addons: *gcc9
      env: CXX=g++-9 BUILD_TYPE=Release LLVM_VERSION=11

script:
  - mkdir build
  - cd build
  - cmake .. -DCMAKE_BUILD_TYPE=${BUILD_TYPE:?} -DLLVM_REQUESTED_VERSION=${LLVM_VERSION} -DPYTHON_EXECUTABLE=$(which python3)
  - cmake --build . -- -j ${JOBS}
  - cmake --build . --target check-vara-feature-unittests
  - cmake --build . --target tidy-vara-feature
  - cmake --build . --target check-vara-feature-python
  - cmake --build . --target check-vara-fm-viewer

branches:
  only:
    - vara
    - vara-dev
